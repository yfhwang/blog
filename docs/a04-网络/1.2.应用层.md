## 应用层？

### HTTP介绍

超文本传输协议，用于从万维网服务器向本地客户端浏览器传输超文本的传送协议(有超链接的文本，例如html页面)

基于TCP(传输控制协议)的应用层协议，不关心数据传输的细节，主要是用来规定客户端和服务器端的数据传输格式，默认端口80

#### 特点

- 基于请求和响应模式（客户/服务器模式）

  ![image-20210413194023007](../images/image-20210413194023007.png)

- 简单

  客户请求服务只需传送请求方法和路径（GET、HEAD、POST）

- 灵活

  允许传输任意类型的数据对象（Content-Type标识），对数据的兼容性强

- 无连接

  限制每次连接只处理一个请求。

  服务器处理完客户的请求，并收到客户的应答后即断开连接；可以节省传输时间，及时释放资源。

  网页中若包含图片：keep alive 保持连接

- 无状态

  协议对于事务处理没有记忆性

  cookie、session：用于保持HTTP连接状态的技术

#### 与tcp的不同

| HTTP               | TCP              |
| ------------------ | ---------------- |
| 应用层             | 传输层           |
| 只规定数据传输格式 | 关心数据传输细节 |
| 无连接无状态       | 面向连接         |



### 请求和响应报文

#### HTTP请求报文

请求行（方法、URL、协议版本）+请求头+空行+请求数据体

![](../images/HTTP_RequestMessageExample.png)

#### HTTP响应报文

状态行（协议版本、状态码、状态码描述）+响应头+空行+响应体

![](../images/HTTP_ResponseMessageExample.png)

### HTTP方法

| 方法    | 意义                                                         |
| ------- | ------------------------------------------------------------ |
| OPTIONS | 请求一些选项信息，允许客户端查看服务器的性能                 |
| GET     | 请求指定的页面信息，并返回实体主体                           |
| HEAD    | 类似于 get 请求，只不过返回的响应中没有具体的内容，用于获取报头 |
| POST    | 向指定资源提交数据进行处理请求（例如提交表单或者上传文件）。数据被包含在请求体中。POST请求可能会导致新的资源的建立和/或已有资源的修改 |
| PUT     | 从客户端向服务器传送的数据取代指定的文档的内容               |
| DELETE  | 请求服务器删除指定的页面                                     |
| TRACE   | 回显服务器收到的请求，主要用于测试或诊断                     |

### 状态码

* 1xx：表示通知信息，如请求收到了或正在进行处理
  * 100 Continue：继续，客户端应继续其请求
  * 101 Switching Protocols 切换协议。服务器根据客户端的请求切换协议。只能切换到更高级的协议，例如，切换到 HTTP 的新版本协议
* 2xx：表示成功，如接收或知道了
  * 200 OK: 请求成功
* 3xx：表示重定向，如要完成请求还必须采取进一步的行动
  * 301 Moved Permanently: 永久移动。请求的资源已被永久的移动到新 URL，返回信息会包括新的 URL，浏览器会自动定向到新 URL。今后任何新的请求都应使用新的 URL 代替
* 4xx：表示客户的差错，如请求中有错误的语法或不能完成
  * 400 Bad Request: 客户端请求的语法错误，服务器无法理解
  * 401 Unauthorized: 请求要求用户的身份认证
  * 403 Forbidden: 服务器理解请求客户端的请求，但是拒绝执行此请求（权限不够）
  * 404 Not Found: 服务器无法根据客户端的请求找到资源（网页）。通过此代码，网站设计人员可设置 “您所请求的资源无法找到” 的个性页面
  * 408 Request Timeout: 服务器等待客户端发送的请求时间过长，超时
* 5xx：表示服务器的差错，如服务器失效无法完成请求
  * 500 Internal Server Error: 服务器内部错误，无法完成请求
  * 503 Service Unavailable: 由于超载或系统维护，服务器暂时的无法处理客户端的请求。延时的长度可包含在服务器的 Retry-After 头信息中
  * 504 Gateway Timeout: 充当网关或代理的服务器，未及时从远端服务器获取请求

> 更多状态码：[菜鸟教程 . HTTP状态码](http://www.runoob.com/http/http-status-codes.html)

### GET和POST

相同：本质都是TCP链接，GET和POST能做的事情是一样的。

1. GET的参数在URL中，POST通过request body传递参数

2. GET请求有大小限制，POST请求无大小限制

3. 安全问题：GET参数会显示在地址栏中，而POST不会，安全性更高。但两种方法都可能被拦截

4. GET会被浏览器主动缓存，如果下一次传输的数据相同，则返回缓存中的内容，用于获取信息而非修改信息，是安全和幂等的；**POST不会被缓存**，每次刷新时数据都会被重新提交，所有有可能修改服务器上的资源，不符合安全和幂等性。

   > 安全：该操作用于获取信息而非修改信息；
   >
   > 幂等性(Idempotence): 则指的是无论调用这个URL 多少次，都不会有不同的结果的 HTTP 方法

5. GET产生一个TCP数据包；POST产生两个TCP数据包

   > 对于GET方式的请求，浏览器会把请求头和请求数据一并发送出去，服务器响应200（返回数据）；
   >
   > 而对于POST，浏览器先发送请求头，服务器响应100 continue，浏览器再发送请求数据，服务器响应200 ok（返回数据）。



### HTTP和HTTPS?

**1.安全性：**

HTTP是**超文本传输协议**，信息明文传输，客户端和服务器端都无法验证对方的身份。

HTTPS协议是由**SSL/TLS+HTTP协议构建的加密传输协议**。信息加密传输，身份认证(CA)，保证数据完整性，比http协议安全，但耗费更多服务器资源

> SSL（Secure Sockets Layer）安全套接字协议：在传输层对网络连接进行加密，是为网络通信提供安全及数据完整性的一种安全协议

### DNS域名解析过程？



### Web页面请求过程

#### 1. DHCP 配置主机信息

- 假设主机最开始没有 IP 地址以及其它信息，那么就需要先使用 DHCP 来获取。

- 主机生成一个 DHCP 请求报文，并将这个报文放入具有目的端口 67 和源端口 68 的 UDP 报文段中。

- 该报文段则被放入在一个具有广播 IP 目的地址(255.255.255.255) 和源 IP 地址（0.0.0.0）的 IP 数据报中。

- 该数据报则被放置在 MAC 帧中，该帧具有目的地址 FF:<zero-width space>FF:<zero-width space>FF:<zero-width space>FF:<zero-width space>FF:FF，将广播到与交换机连接的所有设备。

- 连接在交换机的 DHCP 服务器收到广播帧之后，不断地向上分解得到 IP 数据报、UDP 报文段、DHCP 请求报文，之后生成 DHCP ACK 报文，该报文包含以下信息：IP 地址、DNS 服务器的 IP 地址、默认网关路由器的 IP 地址和子网掩码。该报文被放入 UDP 报文段中，UDP 报文段有被放入 IP 数据报中，最后放入 MAC 帧中。

- 该帧的目的地址是请求主机的 MAC 地址，因为交换机具有自学习能力，之前主机发送了广播帧之后就记录了 MAC 地址到其转发接口的交换表项，因此现在交换机就可以直接知道应该向哪个接口发送该帧。

- 主机收到该帧后，不断分解得到 DHCP 报文。之后就配置它的 IP 地址、子网掩码和 DNS 服务器的 IP 地址，并在其 IP 转发表中安装默认网关。

#### 2. ARP 解析 MAC 地址

- 主机通过浏览器生成一个 TCP 套接字，套接字向 HTTP 服务器发送 HTTP 请求。为了生成该套接字，主机需要知道网站的域名对应的 IP 地址。

- 主机生成一个 DNS 查询报文，该报文具有 53 号端口，因为 DNS 服务器的端口号是 53。

- 该 DNS 查询报文被放入目的地址为 DNS 服务器 IP 地址的 IP 数据报中。

- 该 IP 数据报被放入一个以太网帧中，该帧将发送到网关路由器。

- DHCP 过程只知道网关路由器的 IP 地址，为了获取网关路由器的 MAC 地址，需要使用 ARP 协议。

- 主机生成一个包含目的地址为网关路由器 IP 地址的 ARP 查询报文，将该 ARP 查询报文放入一个具有广播目的地址（FF:<zero-width space>FF:<zero-width space>FF:<zero-width space>FF:<zero-width space>FF:FF）的以太网帧中，并向交换机发送该以太网帧，交换机将该帧转发给所有的连接设备，包括网关路由器。

- 网关路由器接收到该帧后，不断向上分解得到 ARP 报文，发现其中的 IP 地址与其接口的 IP 地址匹配，因此就发送一个 ARP 回答报文，包含了它的 MAC 地址，发回给主机。

#### 3. DNS 解析域名

- 知道了网关路由器的 MAC 地址之后，就可以继续 DNS 的解析过程了。

- 网关路由器接收到包含 DNS 查询报文的以太网帧后，抽取出 IP 数据报，并根据转发表决定该 IP 数据报应该转发的路由器。

- 因为路由器具有内部网关协议（RIP、OSPF）和外部网关协议（BGP）这两种路由选择协议，因此路由表中已经配置了网关路由器到达 DNS 服务器的路由表项。

- 到达 DNS 服务器之后，DNS 服务器抽取出 DNS 查询报文，并在 DNS 数据库中查找待解析的域名。

- 找到 DNS 记录之后，发送 DNS 回答报文，将该回答报文放入 UDP 报文段中，然后放入 IP 数据报中，通过路由器反向转发回网关路由器，并经过以太网交换机到达主机。

#### 4. HTTP 请求页面

- 有了 HTTP 服务器的 IP 地址之后，主机就能够生成 TCP 套接字，该套接字将用于向 Web 服务器发送 HTTP GET 报文。

- 在生成 TCP 套接字之前，必须先与 HTTP 服务器进行三次握手来建立连接。生成一个具有目的端口 80 的 TCP SYN 报文段，并向 HTTP 服务器发送该报文段。

- HTTP 服务器收到该报文段之后，生成 TCP SYN ACK 报文段，发回给主机。

- 连接建立之后，浏览器生成 HTTP GET 报文，并交付给 HTTP 服务器。

- HTTP 服务器从 TCP 套接字读取 HTTP GET 报文，生成一个 HTTP 响应报文，将 Web 页面内容放入报文主体中，发回给主机。

- 浏览器收到 HTTP 响应报文后，抽取出 Web 页面内容，之后进行渲染，显示 Web 页面。



### 常用端口

|       应用       | 应用层协议 | 端口号  | 传输层协议 |            备注             |
| :--------------: | :--------: | :-----: | :--------: | :-------------------------: |
|     域名解析     |    DNS     |   53    |  UDP/TCP   | 长度超过 512 字节时使用 TCP |
| 动态主机配置协议 |    DHCP    |  67/68  |    UDP     |                             |
| 简单网络管理协议 |    SNMP    | 161/162 |    UDP     |                             |
|   文件传送协议   |    FTP     |  20/21  |    TCP     |  控制连接 21，数据连接 20   |
|   远程终端协议   |   TELNET   |   23    |    TCP     |                             |
|  超文本传送协议  |    HTTP    |   80    |    TCP     |                             |
| 简单邮件传送协议 |    SMTP    |   25    |    TCP     |                             |
|   邮件读取协议   |    POP3    |   110   |    TCP     |                             |
| 网际报文存取协议 |    IMAP    |   143   |    TCP     |                             |

### 其他协议

#### 文件传送协议FTP

FTP 使用 TCP 进行连接，它需要两个连接来传送一个文件：

- 控制连接：服务器打开端口号 21 等待客户端的连接，客户端主动建立连接后，使用这个连接将客户端的命令传送给服务器，并传回服务器的应答。

- 数据连接：用来传送文件数据。

  根据**数据连接**是否是服务器端主动建立，FTP 有主动和被动两种模式：

  - 主动模式：服务器端主动建立数据连接，其中服务器端的端口号为 20，客户端的端口号随机（必须大于 1024， 0\~1023 是熟知端口号）。

    主动模式要求客户端开放端口号给服务器端，需要配置客户端的防火墙。

    ![](../images/03f47940-3843-4b51-9e42-5dcaff44858b.jpg)

  - 被动模式：客户端主动建立数据连接，其中客户端的端口号由客户端自己指定，服务器端的端口号随机。

    被动模式下，服务器端开放端口号即可，无需客户端配置防火墙。但是被动模式会导致服务器端的安全性减弱，因为开放了过多的端口号。

    ![](../images/be5c2c61-86d2-4dba-a289-b48ea23219de.jpg)

#### 动态主机配置协议DHCP

DHCP (Dynamic Host Configuration Protocol) 提供了即插即用的连网方式，用户不再需要手动配置 IP 地址等信息。

DHCP 配置的内容不仅是 IP 地址，还包括子网掩码、网关 IP 地址。

DHCP 工作过程如下：

1. 客户端发送 Discover 报文，该报文的目的地址为 255.255.255.255:67，源地址为 0.0.0.0:68，被放入 UDP 中，该报文被广播到同一个子网的所有主机上。如果客户端和 DHCP 服务器不在同一个子网，就需要使用中继代理。
2. DHCP 服务器收到 Discover 报文之后，发送 Offer 报文给客户端，该报文包含了客户端所需要的信息。因为客户端可能收到多个 DHCP 服务器提供的信息，因此客户端需要进行选择。
3. 如果客户端选择了某个 DHCP 服务器提供的信息，那么就发送 Request 报文给该 DHCP 服务器。
4. DHCP 服务器发送 Ack 报文，表示客户端此时可以使用提供给它的信息。

![](../images/23219e4c-9fc0-4051-b33a-2bd95bf054ab.jpg)

#### 远程登录协议telnet

TELNET 用于登录到远程主机上，并且远程主机上的输出也会返回。

TELNET 可以适应许多计算机和操作系统的差异，例如不同操作系统系统的换行符定义。

#### 电子邮件协议

一个电子邮件系统由三部分组成：用户代理、邮件服务器以及邮件协议。

邮件协议包含发送协议和读取协议，发送协议常用 SMTP，读取协议常用 POP3 和 IMAP。

![](../images/23219e4c-9fc0-4051-b33a-2bd95bf054ab.jpg)





## 